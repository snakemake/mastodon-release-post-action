name: Post to Mastodon on Release
description: A GitHub Action to post release announcements to Mastodon
author: Christian Meesters

inputs:
  message:
    description: 'The message to post to Mastodon'
    required: true
  access-token:
    description: 'Mastodon access token for authentication'
    required: true
  pr-title:
    description: 'The title of the pull request'
    required: true
  base-url:
    description: 'The base URL of the Mastodon instance'
    required: false
  image:
    description: 'Path to an image to include in the post'
    required: false
  image-description:
    description: 'Description of the image for accessibility'
    required: false

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y python3-mastodon
      shell: bash
      
    - name: Post to Mastodon
      uses: nick-fields/retry@v2
      with:
        timeout_minutes: 10
        max_attempts: 3
        command: |
          set -o errexit
          
          # Use heredoc to safely pass message content
          MESSAGE=$(cat <<'EOF'
          ${{ inputs.message }}
          EOF
          )
          
          # Heredoc for PR title as well
          PR_TITLE=$(cat <<'EOF'
          ${{ inputs.pr-title }}
          EOF
          )
          
          args=(
            --message "$MESSAGE"
            --access-token "${{ inputs.access-token }}"
            --pr-title "$PR_TITLE"
            )
          
          if [ -n "${{ inputs.base-url }}" ]; then
            args+=(--base-url "${{ inputs.base-url }}")
          fi
          if [ -n "${{ inputs.image }}" ]; then
            args+=(--image "${{ inputs.image }}")
          fi
          if [ -n "${{ inputs.image-description }}" ]; then
            args+=(--image-description "${{ inputs.image-description }}")
          fi
          
          python3 "${{ github.action_path }}/post_to_mastodon.py" "${args[@]}"

